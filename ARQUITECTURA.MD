# ğŸ—ï¸ Arquitectura del Sistema

## ğŸ“Š Diagrama de Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FRONTEND (Next.js 14)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Landing    â”‚  â”‚   Booking    â”‚  â”‚    Admin     â”‚     â”‚
â”‚  â”‚    Pages     â”‚  â”‚    Flow      â”‚  â”‚    Panel     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   API Routes    â”‚
                    â”‚   (Next.js)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
        â–¼                    â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase    â”‚   â”‚   Flow API     â”‚   â”‚   SendGrid     â”‚
â”‚  (PostgreSQL) â”‚   â”‚   (Pagos)      â”‚   â”‚   (Emails)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Stack TecnolÃ³gico

### Frontend
- **Framework**: Next.js 14.2.18 (App Router)
- **UI**: React 18 + TypeScript
- **Styling**: Tailwind CSS 3.4
- **Forms**: React Hook Form + Zod
- **State**: React Context + Hooks
- **Icons**: Lucide React

### Backend
- **Runtime**: Node.js 18+
- **API**: Next.js API Routes
- **Database**: PostgreSQL (Supabase)
- **ORM**: Supabase Client
- **ValidaciÃ³n**: Zod

### Servicios Externos
- **Database & Auth**: Supabase
- **Pagos**: Flow (Chile)
- **Emails**: SendGrid
- **Hosting**: Vercel (recomendado)

### DevOps
- **Package Manager**: pnpm
- **Testing**: Vitest
- **Linting**: ESLint
- **Formatting**: Prettier
- **CI/CD**: GitHub Actions (configuraciÃ³n pendiente)

---

## ğŸ“ Estructura Detallada del Monorepo

```
tres-morros/
â”‚
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ web/                           # AplicaciÃ³n Next.js principal
â”‚       â”œâ”€â”€ app/                       # Next.js App Router
â”‚       â”‚   â”œâ”€â”€ (public)/             # Rutas pÃºblicas
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx          # Landing page
â”‚       â”‚   â”‚   â”œâ”€â”€ cabanas/          # PÃ¡ginas de cabaÃ±as
â”‚       â”‚   â”‚   â””â”€â”€ pago/             # Flujo de pago
â”‚       â”‚   â”œâ”€â”€ admin/                # Rutas protegidas admin
â”‚       â”‚   â”‚   â”œâ”€â”€ layout.tsx        # Layout con auth
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx          # Dashboard
â”‚       â”‚   â”‚   â”œâ”€â”€ login/            # Login admin
â”‚       â”‚   â”‚   â””â”€â”€ reservas/         # GestiÃ³n reservas
â”‚       â”‚   â”œâ”€â”€ api/                  # API Routes
â”‚       â”‚   â”‚   â”œâ”€â”€ availability/     # Disponibilidad
â”‚       â”‚   â”‚   â”œâ”€â”€ bookings/         # CRUD reservas
â”‚       â”‚   â”‚   â”œâ”€â”€ payments/flow/    # IntegraciÃ³n Flow
â”‚       â”‚   â”‚   â”œâ”€â”€ admin/            # APIs admin
â”‚       â”‚   â”‚   â””â”€â”€ jobs/             # Cron jobs
â”‚       â”‚   â”œâ”€â”€ layout.tsx            # Root layout
â”‚       â”‚   â”œâ”€â”€ globals.css           # Estilos globales
â”‚       â”‚   â””â”€â”€ not-found.tsx         # 404
â”‚       â”œâ”€â”€ public/                   # Assets estÃ¡ticos
â”‚       â”‚   â””â”€â”€ images/               # ImÃ¡genes
â”‚       â”œâ”€â”€ next.config.mjs           # Config Next.js
â”‚       â”œâ”€â”€ tailwind.config.ts        # Config Tailwind
â”‚       â”œâ”€â”€ tsconfig.json             # Config TypeScript
â”‚       â””â”€â”€ package.json              # Dependencies (usa @tresmorros/ui como librerÃ­a de componentes)
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ core/                         # LÃ³gica de negocio
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/                # AutenticaciÃ³n
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin.ts         # Auth admin
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ session.ts       # GestiÃ³n sesiones
â”‚   â”‚   â”‚   â”œâ”€â”€ booking/             # LÃ³gica reservas
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ availability.ts  # Disponibilidad
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pricing.ts       # CÃ¡lculo precios
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validation.ts    # Validaciones
â”‚   â”‚   â”‚   â”œâ”€â”€ payment/             # LÃ³gica pagos
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ flow-client.ts   # Cliente Flow
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ webhook.ts       # Webhooks
â”‚   â”‚   â”‚   â”œâ”€â”€ email/               # Emails
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts        # Cliente SendGrid
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.ts       # Servicio email
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ templates/       # Templates
â”‚   â”‚   â”‚   â””â”€â”€ utils/               # Utilidades
â”‚   â”‚   â”‚       â”œâ”€â”€ format.ts        # Formato
â”‚   â”‚   â”‚       â”œâ”€â”€ cn.ts            # Class names
â”‚   â”‚   â”‚       â””â”€â”€ dates.ts         # Manejo fechas
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ database/                     # ConfiguraciÃ³n BD
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts            # Cliente Supabase
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts            # Cliente server
â”‚   â”‚   â”‚   â””â”€â”€ types/               # Tipos generados
â”‚   â”‚   â”‚       â”œâ”€â”€ database.ts      # Tipos BD
â”‚   â”‚   â”‚       â”œâ”€â”€ booking.ts       # Tipos reserva
â”‚   â”‚   â”‚       â”œâ”€â”€ flow.ts          # Tipos Flow
â”‚   â”‚   â”‚       â””â”€â”€ email.ts         # Tipos email
â”‚   â”‚   â”œâ”€â”€ schemas/                 # Esquemas SQL
â”‚   â”‚   â”‚   â”œâ”€â”€ 001_initial.sql     # Schema inicial
â”‚   â”‚   â”‚   â”œâ”€â”€ 002_flow.sql        # IntegraciÃ³n Flow
â”‚   â”‚   â”‚   â””â”€â”€ 003_emails.sql      # Sistema emails
â”‚   â”‚   â”œâ”€â”€ migrations/              # Migraciones
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â””â”€â”€ ui/                          # Biblioteca UI + features
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ ui/                  # Componentes base (Button, Card, Container)
â”‚       â”‚   â”œâ”€â”€ booking/             # Wizard, calendario, formularios
â”‚       â”‚   â”œâ”€â”€ layout/              # Header/Footer reutilizables
â”‚       â”‚   â”œâ”€â”€ features/            # MÃ³dulos funcionales (cabins, gallery, etc.)
â”‚       â”‚   â”œâ”€â”€ sections/            # Secciones completas (home hero, ubicaciÃ³n, propÃ³sito)
â”‚       â”‚   â”œâ”€â”€ forms/               # Formularios compartidos (ContactForm)
â”‚       â”‚   â”œâ”€â”€ types/               # Tipos compartidos (media, props)
â”‚       â”‚   â””â”€â”€ admin/               # Componentes del panel
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ docs/                            # DocumentaciÃ³n
â”‚   â”œâ”€â”€ technical/                   # Docs tÃ©cnicas
â”‚   â”œâ”€â”€ business/                    # Docs negocio
â”‚   â”œâ”€â”€ api/                         # API reference
â”‚   â””â”€â”€ README.md                    # Ãndice principal
â”‚
â”œâ”€â”€ tools/                           # Herramientas
â”‚   â””â”€â”€ scripts/                     # Scripts Ãºtiles
â”‚       â”œâ”€â”€ db-migrate.ts           # Migraciones
â”‚       â”œâ”€â”€ db-seed.ts              # Seed data
â”‚       â””â”€â”€ generate-types.ts       # Generar tipos
â”‚
â”œâ”€â”€ tests/                           # Tests compartidos
â”‚   â”œâ”€â”€ unit/                        # Tests unitarios
â”‚   â”œâ”€â”€ integration/                 # Tests integraciÃ³n
â”‚   â””â”€â”€ e2e/                         # Tests E2E
â”‚
â”œâ”€â”€ .github/                         # GitHub config
â”‚   â””â”€â”€ workflows/                   # CI/CD
â”‚
â”œâ”€â”€ migrations/                      # Migraciones BD (legacy)
â”œâ”€â”€ pnpm-workspace.yaml             # Config monorepo
â”œâ”€â”€ .env.example                    # Template env vars
â”œâ”€â”€ .gitignore                      # Git ignore
â”œâ”€â”€ package.json                    # Root package
â”œâ”€â”€ tsconfig.json                   # TS config base
â””â”€â”€ README.md                       # README principal
```

---

## ğŸ”„ Flujos de Datos Principales

### 1. Flujo de Reserva

```
Usuario selecciona fechas
         â”‚
         â–¼
AvailabilityCalendar hace request a /api/availability
         â”‚
         â–¼
API consulta Supabase (bookings + admin_blocks)
         â”‚
         â–¼
Retorna fechas disponibles/ocupadas
         â”‚
         â–¼
Usuario completa formulario
         â”‚
         â–¼
BookingForm valida con Zod
         â”‚
         â–¼
POST /api/bookings/hold
         â”‚
         â–¼
API crea booking (status: pending, expires_at: +45min)
         â”‚
         â–¼
Redirect a /pago con bookingId
```

### 2. Flujo de Pago

```
Usuario en /pago
         â”‚
         â–¼
Cliente carga datos de booking
         â”‚
         â–¼
Usuario hace click "Pagar"
         â”‚
         â–¼
POST /api/payments/flow/create
         â”‚
         â–¼
Flow crea orden y retorna URL
         â”‚
         â–¼
Redirect a Flow payment page
         â”‚
         â–¼
Usuario completa pago en Flow
         â”‚
         â–¼
Flow hace POST a /api/payments/flow/webhook
         â”‚
         â–¼
API valida HMAC signature
         â”‚
         â–¼
API actualiza booking (status: paid)
         â”‚
         â–¼
API envÃ­a email confirmaciÃ³n
         â”‚
         â–¼
Flow redirige a /pago/confirmacion
         â”‚
         â–¼
Cliente hace polling a /api/bookings/[id]
         â”‚
         â–¼
Muestra estado final (paid/cancelled)
```

### 3. Flujo de ExpiraciÃ³n de Holds

```
Cron job cada 5 minutos
         â”‚
         â–¼
GET /api/jobs/expire-holds
         â”‚
         â–¼
API valida CRON_SECRET
         â”‚
         â–¼
API consulta bookings pendientes con expires_at < NOW()
         â”‚
         â–¼
API actualiza a status: expired
         â”‚
         â–¼
API registra evento en api_events
         â”‚
         â–¼
Retorna count de holds expirados
```

### 4. Flujo de AutenticaciÃ³n Admin

```
Admin accede a /admin
         â”‚
         â–¼
Middleware verifica cookie de sesiÃ³n
         â”‚
         â”œâ”€ No vÃ¡lida â†’ Redirect a /admin/login
         â”‚
         â””â”€ VÃ¡lida â†’ Renderiza dashboard
                    â”‚
                    â–¼
            Carga KPIs y reservas desde Supabase
```

---

## ğŸ” Seguridad

### AutenticaciÃ³n
- **Admin**: Cookie httpOnly con hash SHA256
- **DuraciÃ³n**: 24 horas
- **Secret**: Variable de entorno `ADMIN_PASSWORD`

### API Protection
- **Rate Limiting**: Pendiente implementar
- **CORS**: Configurado en Next.js
- **CSRF**: ProtecciÃ³n automÃ¡tica de Next.js
- **Validation**: Todos los inputs validados con Zod

### Payment Security
- **HMAC Signature**: ValidaciÃ³n en webhooks Flow
- **Secrets**: Variables de entorno nunca expuestas
- **HTTPS**: Obligatorio en producciÃ³n

### Database
- **RLS (Row Level Security)**: Pendiente configurar en Supabase
- **Service Role**: Solo en server-side
- **Anon Key**: Solo operaciones pÃºblicas seguras

---

## ğŸš€ Performance

### Optimizaciones Implementadas
- âœ… Static Generation para pÃ¡ginas de cabaÃ±as
- âœ… Image Optimization con next/image
- âœ… Code Splitting automÃ¡tico (Next.js)
- âœ… CSS Modules con Tailwind
- âœ… API Routes con caching headers

### Optimizaciones Pendientes
- â³ Redis para caching de disponibilidad
- â³ CDN para assets estÃ¡ticos
- â³ Database indexes optimization
- â³ Query optimization (N+1 queries)

---

## ğŸ“Š Monitoreo

### Logs
- **API Events**: Tabla `api_events` en Supabase
- **Errors**: Console logs (mejorar a Sentry)
- **Webhooks**: Logs en Flow dashboard

### MÃ©tricas
- **Performance**: Web Vitals (Next.js built-in)
- **Uptime**: Pendiente (UptimeRobot recomendado)
- **Analytics**: Pendiente (Google Analytics/Plausible)

---

## ğŸ”„ CI/CD

### GitHub Actions (Recomendado)
```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]
jobs:
  test:
    - Install dependencies
    - Run linter
    - Run type check
    - Run tests
    - Build app
  deploy:
    - Deploy to Vercel (on main)
```

---

## ğŸ“š Referencias

- [Next.js Docs](https://nextjs.org/docs)
- [Supabase Docs](https://supabase.com/docs)
- [Flow API Docs](https://www.flow.cl/docs)
- [SendGrid API Docs](https://docs.sendgrid.com)

---

**Ãšltima actualizaciÃ³n**: 2025-11-15
